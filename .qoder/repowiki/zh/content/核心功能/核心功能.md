# 核心功能

<cite>
**本文档引用的文件**   
- [README.md](file://README.md)
- [README_CN.md](file://README_CN.md)
- [config.yaml](file://config/config.yaml)
- [main.go](file://cmd/server/main.go)
- [chat.go](file://internal/models/chat/chat.go)
- [knowledgebase.go](file://internal/application/service/knowledgebase.go)
- [graph.go](file://internal/application/service/graph.go)
- [chunk.go](file://internal/application/service/chunk.go)
- [composite.go](file://internal/application/service/retriever/composite.go)
- [extract.go](file://internal/application/service/extract.go)
- [pdf_parser.py](file://docreader/parser/pdf_parser.py)
- [docx_parser.py](file://docreader/parser/docx_parser.py)
- [markdown_parser.py](file://docreader/parser/markdown_parser.py)
- [KnowledgeBase.vue](file://frontend/src/views/knowledge/KnowledgeBase.vue)
- [index.vue](file://frontend/src/views/chat/index.vue)
</cite>

## 目录
1. [文档管理](#文档管理)
2. [知识库管理](#知识库管理)
3. [智能问答](#智能问答)
4. [知识图谱](#知识图谱)

## 文档管理

WeKnora_New系统支持多种文档格式的解析与处理，包括PDF、Word、Markdown和图像文件。系统通过模块化的文档解析器对上传的文件进行内容提取和结构化处理。

对于PDF文档，系统使用`pdfplumber`库进行解析。解析过程首先将PDF内容写入临时文件，然后逐页读取。系统会尝试使用不同的策略（如基于线条和基于文本）来检测表格，并将表格内容转换为Markdown格式。非表格的文本内容则直接提取，最终将所有页面的内容合并为一个完整的文本流。

对于Word文档（.docx），系统使用`python-docx`库进行解析。解析器会处理文档中的段落和表格，提取纯文本内容。对于文档中的图片，系统会尝试提取并保存为临时文件，以便后续进行OCR处理。解析器还实现了多线程处理机制，以提高大文档的处理效率。

对于Markdown文档，系统采用简单的文本提取方式，直接将文件内容解码为字符串，保留原有的Markdown格式，但不处理其中的图片链接。

对于图像文件，系统支持通过OCR（光学字符识别）技术提取其中的文本内容。系统配置了`enable_multimodal`选项来控制是否启用多模态处理，允许从图像中提取文字和生成描述。

文档处理流程遵循RAG（检索增强生成）范式，首先将文档分割成大小为512个字符的块（chunk），并设置50个字符的重叠区域以保证上下文的连续性。这些文档块随后被用于向量化索引，为后续的语义检索提供基础。

**Section sources**
- [pdf_parser.py](file://docreader/parser/pdf_parser.py)
- [docx_parser.py](file://docreader/parser/docx_parser.py)
- [markdown_parser.py](file://docreader/parser/markdown_parser.py)
- [config.yaml](file://config/config.yaml)

## 知识库管理

知识库管理是WeKnora_New系统的核心功能之一，允许用户创建、配置和管理多个独立的知识库。每个知识库可以包含多个文档，并拥有独立的配置参数。

知识库的创建通过`knowledgebase.go`中的`CreateKnowledgeBase`服务实现。当用户创建一个新的知识库时，系统会为其生成一个唯一的UUID作为ID，并记录创建时间。知识库的配置信息包括分块大小（chunk_size）、分块重叠（chunk_overlap）和分隔符（split_markers）等，这些参数在`config.yaml`文件中定义。

知识库的更新通过`UpdateKnowledgeBase`方法实现，允许修改知识库的名称、描述和配置。系统还支持知识库的复制功能，通过`CopyKnowledgeBase`方法可以创建一个现有知识库的副本，实现配置的快速复用。

知识库的删除操作会移除知识库本身及其所有关联的文档和数据。系统通过`DeleteKnowledgeBase`方法执行此操作，并确保在向量数据库中清理相关的索引。

前端界面`KnowledgeBase.vue`提供了知识库的可视化管理。用户可以通过拖拽方式上传文档，系统会显示文档的处理进度和状态（如“处理中”、“已完成”或“失败”）。界面还支持文档的删除操作，并通过弹窗确认来防止误删。

知识库与嵌入模型（embedding model）相关联，系统允许为每个知识库指定不同的嵌入模型。通过`SetEmbeddingModel`方法，可以将知识库与特定的模型ID绑定，从而在检索时使用相应的向量表示。

**Section sources**
- [knowledgebase.go](file://internal/application/service/knowledgebase.go)
- [KnowledgeBase.vue](file://frontend/src/views/knowledge/KnowledgeBase.vue)
- [config.yaml](file://config/config.yaml)

## 智能问答

智能问答功能基于RAG（检索增强生成）架构，结合了上下文感知、多轮对话和提示词模板等技术，为用户提供精准的问答服务。

系统支持上下文感知的多轮对话。在`chat.go`中定义了`ChatOptions`结构，其中包含`Thinking`字段，用于控制是否启用思考模式。当用户提出问题时，系统会结合历史对话上下文，通过`rewrite_prompt`模板对问题进行改写，消解代词并补全省略信息，确保问题的语义完整。

多轮对话的管理通过会话（session）机制实现。前端`index.vue`中的`chat`组件维护了一个消息列表，记录用户和助手的交互历史。当用户发送新消息时，系统会将整个对话历史作为上下文传递给大语言模型，从而实现连贯的多轮对话。

提示词模板在`config.yaml`文件中进行了详细配置。系统定义了多种模板，如`rewrite_prompt_system`用于问题改写，`keywords_extraction_prompt`用于关键词提取，以及`context_template`用于构建最终的问答上下文。这些模板通过变量注入（如`{{.Query}}`）来动态生成提示词，确保了灵活性和可配置性。

问答流程由`chat_pipline.go`中的事件管理器（EventManager）协调。系统首先执行检索（search）插件，从知识库中获取相关文档块；然后执行重排（rerank）插件，对检索结果进行排序；最后调用大语言模型生成最终答案。如果检索无结果，系统会返回预设的回退响应。

前端界面通过流式（stream）API实时显示模型的生成过程，用户可以看到“思考中”的动画，直到答案完全生成。这种设计提升了用户体验，让用户感知到系统正在积极处理请求。

**Section sources**
- [chat.go](file://internal/models/chat/chat.go)
- [chat_pipline.go](file://internal/application/service/chat_pipline/chat_pipline.go)
- [config.yaml](file://config/config.yaml)
- [index.vue](file://frontend/src/views/chat/index.vue)

## 知识图谱

知识图谱功能是WeKnora_New系统的高级特性，能够从文档中自动提取实体和关系，并构建语义关联网络，从而增强检索的广度和深度。

知识图谱的构建由`graph.go`中的`graphBuilder`实现。系统首先使用大语言模型从文档块中提取实体。实体类型包括人物（Person）、组织（Organization）、地点（Location）等，这些类型在`extract_entities_prompt`中明确定义。提取的实体会存储在`entityMap`中，并通过标题进行索引。

在实体提取的基础上，系统进一步提取实体之间的关系。关系提取同样依赖大语言模型，通过`extract_relationships_prompt`模板分析实体间的语义联系。关系具有强度（strength）属性，用于量化关系的紧密程度，例如“创作”关系的强度为10分，“提及”关系的强度为7分。

构建的知识图谱不仅用于可视化展示，还直接服务于检索流程。在`extract.go`中，系统通过异步任务（asynq.Task）对文档块进行实体关系提取，并将结果存储在图数据库中。当用户提问时，检索引擎可以利用知识图谱找到直接和间接相关的文档块，从而提供更全面的答案。

知识图谱的可视化通过前端界面展示，用户可以直观地看到文档中不同概念之间的关联。这种可视化不仅帮助用户理解文档内容，也为知识的探索和发现提供了新的途径。

**Section sources**
- [graph.go](file://internal/application/service/graph.go)
- [extract.go](file://internal/application/service/extract.go)
- [config.yaml](file://config/config.yaml)