# WeKnora 路由与中间件架构

## 概览
- 文件：`internal/router/router.go`
- 作用：构建并配置全局 HTTP 服务器，包括中间件栈、跨域配置、健康检查，以及 `/api/v1` 下所有功能路由的注册。
- 技术栈：`gin-gonic/gin`、`gin-contrib/cors`、`go.uber.org/dig`（依赖注入）

## 依赖注入
- 构造函数：`NewRouter(params RouterParams)` 通过 `dig.In` 接收所有 Handler 与 Service 实例
- 参数结构：`RouterParams` 包含配置、服务、处理器，示例字段：
  - `Config *config.Config`
  - `TenantService interfaces.TenantService`
  - `KBHandler *handler.KnowledgeBaseHandler`
  - 其余见 `internal/router/router.go:16–41`

## 中间件栈（执行顺序）
- CORS（跨域）`internal/router/router.go:48–55`
  - `AllowOrigins: *`
  - `AllowMethods: GET/POST/PUT/PATCH/DELETE/OPTIONS`
  - `AllowHeaders: Origin/Content-Type/Accept/Authorization/X-API-Key/X-Request-ID`
  - `ExposeHeaders: Content-Length/Access-Control-Allow-Origin`
  - `AllowCredentials: true`
  - `MaxAge: 12h`
- 请求标识：`middleware.RequestID()`（写入 `RequestID`）
- 统一日志：`middleware.Logger()`（使用 `logrus` 打点）
- 崩溃恢复：`middleware.Recovery()`
- 统一错误响应：`middleware.ErrorHandler()`
- 认证：`middleware.Auth(...)`（支持 JWT 与 `X-API-Key`，将 `TenantID/TenantInfo/user` 注入上下文）
- 追踪：`middleware.TracingMiddleware()`（OpenTelemetry 链路追踪）

## 路由结构
- 健康检查：`GET /health` 返回 `{status: "ok"}`（`internal/router/router.go:68–70`）
- 版本分组：`/api/v1`（`internal/router/router.go:73–87`）
  - 认证：`RegisterAuthRoutes`（注册/登录/刷新/校验/注销/当前用户）
  - 租户：`RegisterTenantRoutes`（增删改查列表）
  - 知识库：`RegisterKnowledgeBaseRoutes`（增删改查、混合搜索、复制）
  - 知识：`RegisterKnowledgeRoutes`（从文件/URL创建、列表、详情、删除、更新、下载、图像分块更新）
  - 分块：`RegisterChunkRoutes`（列表、删除、批量删除、更新）
  - 会话：`RegisterSessionRoutes`（创建、详情、列表、更新、删除、生成标题、继续流）
  - 聊天：`RegisterChatRoutes`（基于知识库的问答、无会话的知识搜索）
  - 消息：`RegisterMessageRoutes`（加载更早消息、删除）
  - 模型：`RegisterModelRoutes`（增删改查、列表）
  - 评估：`RegisterEvaluationRoutes`（创建任务/获取结果）
  - 初始化：`RegisterInitializationRoutes`（键入配置、Ollama 状态/模型、远程模型检查、测试多模态/embedding/rerank、抽取工具）
  - 系统：`RegisterSystemRoutes`（系统信息）

## 关键职责
- 路由注册：集中声明所有 HTTP API 的 URL → Handler 映射
- 中间件编排：确保 CORS 最先、认证和错误处理生效、日志与追踪贯穿
- 可观测性：`RequestID`、统一日志与 OTel 使得跨层追踪一致（Handler→Service→Repo）
- 安全性：认证中间件将租户/用户写入 `gin.Context` 与 `context.Context`，便于后续鉴权与配额检查

## 与前端/客户端的关系
- 前端 API 示例：
  - `listKnowledgeBases()` 调用 `GET /api/v1/knowledge-bases`（`frontend/src/views/knowledge/KnowledgeBaseList.vue:103–115`）
  - 文件上传：`POST /api/v1/knowledge-bases/:id/knowledge/file`（由 `RegisterKnowledgeRoutes` 注册）
- 客户端示例：
  - `client/knowledge.go` 中的上传和拉取接口与这些路由保持一致

## 如何新增路由
1. 创建对应 Handler 方法（`internal/handler/...`）
2. 在 `router.go` 增加组注册函数或在已有组中注册新路径
3. 确保中间件与鉴权需求一致（公共/需认证）
4. 前端或 SDK 对应更新调用入口

## 代码索引
- CORS：`internal/router/router.go:48–55`
- 中间件栈：`internal/router/router.go:57–66`
- 版本分组与路由注册：`internal/router/router.go:72–87`
- 具体路由映射：`internal/router/router.go:92–282`